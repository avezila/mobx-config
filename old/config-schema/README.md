# Конфигуратор форм

## Общая концепция

1) Описывается структура формы, типы полей, формат полей, и валидация полей и формы
в неком формате который описан ниже.
2) Парсер преобразует этот формат в json.
3) Создается экземпляр конфигуратора (класс, который заранее написан на js), 
  ему передается подпуть конфигурации, контекст с данными и на выходе вычесленный
  объект с конфигурацией формы ко описнию и контекста с данным.
4) Какой-то клиентский код просто смотрит на конфигурацию и рисует саму форму.

## Структура файлов и папок

* Формат описывается на языке yaml http://www.yaml.org/spec/1.2/spec.html
* Каждая папка и файл это объект на уровне этой папки или файла
  * /offer/Repairs.yaml внутри содержатся ключи на уровне {offer: {Repairs: {...}}}
  * /offer.yaml внутри содержатся ключи на уровне {offer: {...}}
  * сначала берутся ключи в файле /offer/Repairs.yaml
  * затем на него накладываются ключи структуры Repairs внутри файла /offer.yaml

## Мерж подпутей дерева в другие подпути

* Поумолчанию работает обычное дописывание всех ключей которые подпадают под один уровень
  последовательно в объект на этом уровне
* Можно определить другую операцию мержа например:

```yaml
Repairs: 
  a: 1
  b: 2
  c: 3
  $UPDATE:
    b: 22
    d: 33
```

$UPDATE обновит только те ключи, значение которых уже определенно на объекте текущего уровня
в итоге в Repairs будет:

```yaml
Repairs:
  a: 1
  b: 22
  c: 3
```

* Можно вставить на текущем уровне другой подуровень общей конфигурации:

RealtyType.yaml
```yaml
WAREHOUSE_COMMERCIAL: Производственно-складское помещение
FREE_COMMERCIAL:      Помещение свободного назначения
```

RealtyTypeShort.yaml
```yaml
$EXTEND: ./RealtyType
WAREHOUSE_COMMERCIAL: ПСН
```

Это равносильно:

RealtyTypeShort.yaml
```yaml
WAREHOUSE_COMMERCIAL: Производственно-складское помещение
FREE_COMMERCIAL:      Помещение свободного назначения
WAREHOUSE_COMMERCIAL: ПСН
```

Что равносильно:

RealtyTypeShort.yaml
```yaml
FREE_COMMERCIAL:      Помещение свободного назначения
WAREHOUSE_COMMERCIAL: ПСН
```

* Можно делать условия с помощью $SWITCH:

```yaml
A: AAAA
B: BBBB
C: CCC

$SWITCH:
  $BY: ../computed/isLandIndustrial
  true:
    $PICK:
    - A
    - B
  false: 
    $PICK:
    - B
    - C
```

по значению на уровне ../computed/isLandIndustrial будет выбраны либо только ключи A B, либо B C

так же полезно делать $SWITCH по каким-то полям контекста, например:

```yaml

NEEDS_CAPITAL: Неудовлетворительное
WITHOUT_REPAIR: Без отделки
NEEDS_COSMETIC: Удовлетворительное
GOOD: Хорошее

$SWITCH:
  $BY: $user.company
  rzd:
    $REPLACE:
      GOOD: Хорошее
      NEEDS_COSMETIC: Удовлетворительное
      NEEDS_CAPITAL: Неудовлетворительное
```

## Операции по мержу структур

* по умолачиню просто дописываются ключи вниз в структуру
* $UPDATE: обновляет только те ключи которые уже есть в структуре выше
* $REPLACE: полностью заменяет все ключи на новые
* $PICK: выбирает часть ключей из списка уже определенных
* $OMIT: удаляет часть ключей из списка уже определенных

## Логика:

* $SWITCH:
```yaml
$SWITCH:
  $VALUE:
    DD: 4 # дефолтное значение, если не подошла ни одна из switch
  $BY: $offer.marketType
  OFFICE_COMMERCIAL:
    A: 1
    B: 2
  TRADE: 
    A: 2
    B: 3
```

## Контекст:

* Контекст отвечает за данные, которые приходят из вне и на основе которых строится конфигурация
* Конфигурация автоматически пересчитывается когда меняется какое-то из значений в контексте
* Например для формы редактирования offer в контексте:
  * $filter - фильтр на карте
  * $offer - текущий оффер для которого считается форма
  * $user - текущий пользователь в котором например определен  $user.company

## Исключительные ситуации

* если в $SWITCH:$BY приходит null или пустой массив то накладываются все значения друг за другом
* если в используется кой-то уровень конфигурации который не определен или значение из контекста, то оно возвращается как undefined

## Javascript

Иногда хочется определить какую-то логику, которую сложно сделать через $SWITCH, но не хочется городить костыли вне конфигуратора, для этого можно использовать $JS
Да его будет сложнее отредактировать не программисту, но их можно заранее определить как computed значения, а потом просто переиспользовать по ключу, например:

```yaml
$JS:
  if (($offer.space1 + $offer.space2) !== $offer.space3) {
    return 'Сумма площадей  a и b должна быть ровна площади с'
  }
```

Расчитывает value на текущем уровне на основе context как true или false
Можно так же переиспользовать уже вычесленные подпути конфигурации через
$('../enum/RealtyType')

В конструкции $('../a/b/c') путь резолвится относительно текущего, как будто текущая структура это файл, а все пути уровни сверху это папки, в качестве абстрактной файловой системы работает вычисляемый json конфигурации.